name: Publish to PyPI, NPM, and pub.dev

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.5.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version to publish (e.g., 0.5.0)'
        required: true
        type: string

jobs:
  # Preflight checks before publishing
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag or input
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Dart/Flutter
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Check version consistency
        run: |
          PYTHON_VERSION=$(grep '^version = ' packages/python/pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TS_VERSION=$(node -p "require('./packages/typescript/package.json').version")
          DART_VERSION=$(grep '^version:' packages/dart/pubspec.yaml | awk '{print $2}')

          echo "Python version: $PYTHON_VERSION"
          echo "TypeScript version: $TS_VERSION"
          echo "Dart version: $DART_VERSION"

          if [ "$PYTHON_VERSION" != "$TS_VERSION" ] || [ "$TS_VERSION" != "$DART_VERSION" ]; then
            echo "âŒ Version mismatch!"
            exit 1
          fi

          if [ "$PYTHON_VERSION" != "${{ steps.get-version.outputs.version }}" ]; then
            echo "âŒ Version mismatch with tag!"
            exit 1
          fi

          echo "âœ… All versions are consistent: $PYTHON_VERSION"

      - name: Python - Install dependencies
        working-directory: packages/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Python - Run tests with coverage
        working-directory: packages/python
        run: |
          pytest tests/ --cov=catalogmx --cov-branch -q

      - name: Python - Check coverage threshold
        working-directory: packages/python
        run: |
          coverage report --fail-under=90

      - name: Python - Check code formatting
        working-directory: packages/python
        run: |
          black --check catalogmx/

      - name: Python - Run linting
        working-directory: packages/python
        run: |
          ruff check catalogmx/

      - name: TypeScript - Install dependencies
        working-directory: packages/typescript
        run: npm install

      - name: TypeScript - Run linting
        working-directory: packages/typescript
        run: npm run lint

      - name: TypeScript - Type checking
        working-directory: packages/typescript
        run: npm run typecheck

      - name: TypeScript - Run tests
        working-directory: packages/typescript
        run: npm test

      - name: TypeScript - Build
        working-directory: packages/typescript
        run: npm run build

      - name: Dart - Get dependencies
        working-directory: packages/dart
        run: dart pub get

      - name: Dart - Run analysis
        working-directory: packages/dart
        run: dart analyze

      - name: Dart - Check formatting
        working-directory: packages/dart
        run: dart format --set-exit-if-changed .

      - name: Dart - Run tests
        working-directory: packages/dart
        run: dart test

      - name: Dart - Dry run publish
        working-directory: packages/dart
        run: dart pub publish --dry-run

  # Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: preflight
    environment: pypi
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Python package
        working-directory: packages/python
        run: |
          rm -rf dist/ build/ *.egg-info
          python -m build

      - name: Verify distribution
        working-directory: packages/python
        run: |
          python -m twine check dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/python/dist/
          verbose: true

  # Publish to NPM
  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: preflight
    environment: npm

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        working-directory: packages/typescript
        run: npm install

      - name: Build TypeScript package
        working-directory: packages/typescript
        run: npm run build

      - name: Publish to NPM
        working-directory: packages/typescript
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Publish to pub.dev
  publish-pubdev:
    name: Publish to pub.dev
    runs-on: ubuntu-latest
    needs: preflight
    environment: pubdev

    steps:
      - uses: actions/checkout@v4

      - name: Set up Dart/Flutter
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Get dependencies
        working-directory: packages/dart
        run: dart pub get

      - name: Setup pub.dev credentials
        run: |
          mkdir -p ~/.pub-cache
          echo '${{ secrets.PUB_CREDENTIALS }}' > ~/.pub-cache/credentials.json

      - name: Publish to pub.dev
        working-directory: packages/dart
        run: dart pub publish --force

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-pypi, publish-npm, publish-pubdev]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract changelog
        id: changelog
        run: |
          VERSION=${{ steps.get-version.outputs.version }}

          # Try to extract from Python CHANGELOG first
          if [ -f packages/python/CHANGELOG.rst ]; then
            CHANGELOG=$(sed -n "/^${VERSION}/,/^[0-9]/p" packages/python/CHANGELOG.rst | head -n -1)
          fi

          # Fallback to Dart CHANGELOG
          if [ -z "$CHANGELOG" ] && [ -f packages/dart/CHANGELOG.md ]; then
            CHANGELOG=$(sed -n "/## \[${VERSION}\]/,/## \[/p" packages/dart/CHANGELOG.md | head -n -1)
          fi

          # If no changelog found, use generic message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release version ${VERSION}"
          fi

          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: catalogmx v${{ steps.get-version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post-release summary
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          echo "ğŸ‰ Successfully published catalogmx v${VERSION} to:"
          echo "  ğŸ“¦ PyPI:    https://pypi.org/project/catalogmx/${VERSION}/"
          echo "  ğŸ“¦ NPM:     https://www.npmjs.com/package/catalogmx/v/${VERSION}"
          echo "  ğŸ“¦ pub.dev: https://pub.dev/packages/catalogmx/versions/${VERSION}"
          echo "  ğŸ·ï¸  GitHub:  https://github.com/openbancor/catalogmx/releases/tag/v${VERSION}"
